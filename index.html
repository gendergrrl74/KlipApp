<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema TenSe AIOK v2.1 (Corregido)</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --primary: #2c5530; 
            --secondary: #007bff;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --light: #f8f9fa;
            --dark: #333;
            --neutral-node: #cccccc;
            --path-color: #888;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--light); color: var(--dark); line-height: 1.6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 10px; }
        h5 { text-align: center; color: #666; margin-bottom: 20px; font-weight: normal; }
        
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .input-item label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--dark); }
        .input-item input, .input-item select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .input-item input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; }

        button { display: block; width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #1e3d21; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tabs button { background: none; color: var(--dark); padding: 10px 20px; border: none; cursor: pointer; transition: border-bottom 0.3s; border-radius: 0; font-size: 16px; font-weight: normal; }
        .tabs button.active { border-bottom: 3px solid var(--secondary); font-weight: bold; color: var(--secondary); }
        .tab-content { padding: 10px 0; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Resultados */
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .result-card { background: var(--light); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary); }
        .result-card h3 { color: var(--primary); margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }

        .tense-danger { color: var(--danger); font-weight: bold; }
        .tense-warning { color: var(--warning); font-weight: bold; }
        .tense-success { color: var(--success); font-weight: bold; }

        .tikun-practice { border: 1px solid #ccc; padding: 15px; margin-top: 15px; border-radius: 8px; background: #f0f8ff; }
        .sdh-analysis { border: 2px solid var(--primary); padding: 20px; margin-top: 20px; border-radius: 10px; background: #e6ffe6; }
        
        .sdh-context { border: 1px dashed var(--secondary); padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #eaf3ff; text-align: center; }
        .sdh-detail-sub { font-size: 0.9em; color: #555; margin-top: 5px; }

        /* √Årbol de la Vida SVG */
        .sefirot-map-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .sefirot-map { width: 300px; height: 550px; margin: 20px auto; position: relative; background: white; border: 1px solid #ccc; border-radius: 10px; }
        .sefirot-map svg { position: absolute; top: 0; left: 0; width: 100%; height: 550px; z-index: 1; }
        .sefirot-map .path { stroke: var(--path-color); stroke-width: 2; }
        
        .sefira-node { 
            width: 50px; height: 50px; border-radius: 50%; 
            background-color: var(--neutral-node); 
            border: 2px solid #555; 
            position: absolute; display: flex; align-items: center; justify-content: center; 
            color: black; font-size: 9px; font-weight: bold; text-align: center; line-height: 1.1; padding: 2px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.3); 
            transition: background-color 0.5s, color 0.5s; 
            z-index: 2; 
        }
        
        /* --- COORDENADAS CORREGIDAS (Vista Frontal) --- */
        /* Pilar Izquierdo (Rigor): Left 25px */
        /* Pilar Derecho (Misericordia): Left 225px */
        /* Pilar Central (Equilibrio): Left 125px */

        #Keter { top: 10px; left: 125px; } 

        #Binah { top: 80px; left: 25px; }   /* Izquierda - Severidad */
        #Jojm√° { top: 80px; left: 225px; }  /* Derecha - Sabidur√≠a */

        #Guevur√° { top: 180px; left: 25px; } /* Izquierda - Rigor */
        #J√©sed { top: 180px; left: 225px; }  /* Derecha - Misericordia */

        #Tiferet { top: 280px; left: 125px; }

        #Hod { top: 350px; left: 25px; }     /* Izquierda - Esplendor/Raz√≥n */
        #Netzaj { top: 350px; left: 225px; } /* Derecha - Victoria */

        #Yesod { top: 410px; left: 125px; } 
        #Maljut { top: 490px; left: 130px; width: 40px; height: 40px; } 
        
        /* --- CLASES DE COLOR (IMPORTANTE: NO BORRAR) --- */
        .color-desborde { 
            background-color: var(--danger) !important; 
            color: white !important; 
            border-color: white !important; 
        }
        .color-vaciado { 
            background-color: black !important; 
            color: white !important; 
            border-color: white !important; 
        }

        .sefirot-legend { padding: 20px; border: 1px solid #ddd; border-radius: 8px; align-self: flex-start; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; font-size: 14px; }
        .legend-box { width: 15px; height: 15px; margin-right: 10px; border-radius: 3px; border: 1px solid #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema TenSe AIOK v2.1</h1>
        <h5>Diagn√≥stico Integral con Motor de Hora Planetaria</h5>

        <div class="input-group">
            <div class="input-item">
                <label for="day">D√≠a (D)</label>
                <input type="number" id="day" min="1" max="31" required value="25" onchange="updateSDH()">
            </div>
            <div class="input-item">
                <label for="month">Mes (M)</label>
                <input type="number" id="month" min="1" max="12" required value="3" onchange="updateSDH()">
            </div>
            <div class="input-item">
                <label for="year">A√±o (A)</label>
                <input type="number" id="year" min="1900" max="2100" required value="2025" onchange="updateSDH()">
            </div>
            <div class="input-item">
                <label for="hourInput">Hora Nacimiento (HH:MM)</label>
                <input type="time" id="hourInput" required value="14:00" onchange="updateSDH()"> 
            </div>
            <div class="input-item">
                <label for="sdhPlanet">SDH (Planeta/Sefir√°)</label>
                <input type="text" id="sdhPlanet" readonly placeholder="Calculando...">
            </div>
            <div class="input-item">
                <label for="symptom">Rasgo Psicol√≥gico</label>
                <select id="symptom" required>
                    <option value="Analisis General">An√°lisis General (Focus: Klipot TenSe)</option> 
                    <option value="Rigidez Mental" selected>Rigidez Mental</option>
                    <option value="Perfeccionismo y Temor a la Insuficiencia">Perfeccionismo</option>
                    <option value="Aislamiento Emocional">Aislamiento Emocional</option>
                    <option value="Pesimismo Cr√≥nico">Pesimismo Cr√≥nico</option>
                    <option value="Celos y Rivalidad">Celos y Rivalidad</option>
                    <option value="Dependencia Emocional">Dependencia Emocional</option>
                    <option value="Procrastinaci√≥n Cr√≥nica">Procrastinaci√≥n Cr√≥nica</option>
                    <option value="Huida/Ansiedad ante Desaf√≠os">Huida/Ansiedad ante Desaf√≠os</option>
                    <option value="Tiran√≠a e Ira">Tiran√≠a e Ira</option>
                    <option value="Vanidad y Narcisismo">Vanidad y Narcisismo</option>
                </select>
            </div>
        </div>

        <button id="calculateBtn">‚ú® Analizar Tikun (TenSe)</button>
        
        <div id="results" style="display: none; margin-top: 30px;">
            <div class="tabs">
                <button data-tab="analysis" class="active" onclick="showTab('analysis')">üìä Mapa TenSe</button>
                <button data-tab="sdh" onclick="showTab('sdh')">ü™ê Diagn√≥stico SDH</button>
                <button data-tab="tikkun" onclick="showTab('tikkun')">‚úÖ Tikun Integrado</button>
            </div>

            <div class="tab-content">
                <div id="analysis-tab" class="tab-pane active"></div>
                <div id="sdh-tab" class="tab-pane"></div>
                <div id="tikkun-tab" class="tab-pane"></div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // 1. DATA Y CONSTANTES
        // =================================================================
        const CSS_COLORS = { danger: '#dc3545', warning: '#ffc107', success: '#28a745', secondary: '#007bff' };
        const TENSE_COLORS_MAP = { 'tense-danger': CSS_COLORS.danger, 'tense-warning': CSS_COLORS.warning, 'tense-success': CSS_COLORS.success, 'default': CSS_COLORS.secondary };

        const KLIPOT = {
            1: { mida: "Voluntad, Unidad, Fe", klipa: "Ate√≠smo, Tiran√≠a" },
            2: { mida: "Diplomacia, Colaboraci√≥n", klipa: "Dependencia, Ilusi√≥n" },
            3: { mida: "Creatividad, Optimismo", klipa: "Vanidad, Dispersi√≥n" },
            4: { mida: "Disciplina, Estabilidad", klipa: "Rigidez, Aislamiento" },
            5: { mida: "Libertad, Cambio", klipa: "Exceso, Impulsividad" },
            6: { mida: "Responsabilidad, Servicio", klipa: "Victimismo, Ansiedad" },
            7: { mida: "Fe, Sabidur√≠a Interna", klipa: "Aislamiento, Pesimismo" },
            8: { mida: "Poder, √âxito", klipa: "Codicia, Control" },
            9: { mida: "Verdad, Idealismo", klipa: "Falsedad, Fantas√≠a" },
            10: { mida: "Independencia, Acci√≥n", klipa: "Inercia, Fracaso" }
        };

        const CORRESPONDENCIA_PLANETA_SEFIRA = {
            "Saturno": "Binah (Estructura)", "Jupiter": "J√©sed (Expansi√≥n)", "Marte": "Guevur√° (Rigor)",
            "Sol": "Tiferet (Armon√≠a)", "Venus": "Netzaj (Emoci√≥n)", "Mercurio": "Hod (Raz√≥n)",
            "Luna": "Yesod (V√≠nculo)", "Tierra": "Maljut (Reino)"
        };

        // Secuencia Caldea
        const ORDEN_CALDEA = ["Saturno", "Jupiter", "Marte", "Sol", "Venus", "Mercurio", "Luna"];
        const REGENTE_DEL_DIA = { 0: "Sol", 1: "Luna", 2: "Marte", 3: "Mercurio", 4: "Jupiter", 5: "Venus", 6: "Saturno" };

        const SEFIRA_TO_ID = { "Keter": "Keter", "Jojm√°": "Jojm√°", "Binah": "Binah", "J√©sed": "J√©sed", "Guevur√°": "Guevur√°", "Tiferet": "Tiferet", "Netzaj": "Netzaj", "Hod": "Hod", "Yesod": "Yesod", "Maljut": "Maljut" };
        const TENSE_STRUCTURAL_MAP = { "Alma (D√≠a)": ["Tiferet"], "Karma (Mes)": ["Yesod"], "Destino (A√±o)": ["Binah"], "Misi√≥n (Total)": ["Maljut"] };

        // =================================================================
        // 2. L√ìGICA DE HORA PLANETARIA
        // =================================================================
        
        let GLOBAL_SDH_CONTEXT = { planet: "", rulerOfDay: "" };

        function getRealPlanetaryHour(day, month, year, timeString) {
            if (!timeString) return { planet: "Sol", rulerOfDay: "Sol" };

            let date = new Date(year, month - 1, day);
            let dayIndex = date.getDay(); // 0 = Domingo
            
            const [hours, minutes] = timeString.split(':').map(Number);
            
            // Regla: El d√≠a cabal√≠stico empieza a las 6:00 AM
            let hoursSinceSunrise;
            
            if (hours < 6) {
                dayIndex = (dayIndex - 1 + 7) % 7; 
                hoursSinceSunrise = (24 - 6) + hours; 
            } else {
                hoursSinceSunrise = hours - 6;
            }

            const rulerPlanet = REGENTE_DEL_DIA[dayIndex];
            const startIndex = ORDEN_CALDEA.indexOf(rulerPlanet);
            const planetIndex = (startIndex + hoursSinceSunrise) % 7;
            
            return {
                planet: ORDEN_CALDEA[planetIndex], 
                rulerOfDay: rulerPlanet 
            };
        }

        function updateSDH() {
            const day = parseInt(document.getElementById('day').value);
            const month = parseInt(document.getElementById('month').value);
            const year = parseInt(document.getElementById('year').value);
            const time = document.getElementById('hourInput').value;
            const sdhInput = document.getElementById('sdhPlanet');
            
            if (day && month && year && time) {
                const resultado = getRealPlanetaryHour(day, month, year, time);
                GLOBAL_SDH_CONTEXT = resultado;

                const sefiraData = CORRESPONDENCIA_PLANETA_SEFIRA[resultado.planet];
                const sefiraNombre = sefiraData ? sefiraData.split('(')[0].trim() : "Desconocida";

                sdhInput.value = `${resultado.planet} (${sefiraNombre})`;
            } else {
                sdhInput.value = 'Faltan datos...';
            }
            
            if (document.getElementById('results').style.display === 'block') {
                 calculateAIOK();
            }
        }

        // =================================================================
        // 3. L√ìGICA NUMEROL√ìGICA TENSE
        // =================================================================

        function reduceNumber(num) {
            if (num === 11 || num === 22) return num;
            let sum = num;
            while (sum > 9) {
                sum = String(sum).split('').reduce((acc, digit) => acc + parseInt(digit), 0);
            }
            return sum;
        }

        function calculateKliChallenges(rD, rM, rA) {
            const kliAlma = Math.abs(rD - rM);        
            const kliKarma = Math.abs(rM - rA);      
            const kliDestino = Math.abs(rD - rA);    
            const kliMision = reduceNumber(rD + rM + rA); 
            return { kliAlma, kliKarma, kliDestino, kliMision };
        }
        
        function calculateTense(or, kli) {
            const or_kli = or / kli;
            let state, cssClass;
            if (kli === 0) { 
                state = "Equilibrio Absoluto (‚àû)"; cssClass = "tense-success";
            } else if (or_kli < 0.7) {
                state = "Subpresi√≥n (Vaciado)"; cssClass = "tense-danger";
            } else if (or_kli >= 0.7 && or_kli < 1.0) {
                state = "Subpresi√≥n Moderada"; cssClass = "tense-warning";
            } else if (or_kli === 1.0) {
                state = "Punto Cr√≠tico (Maestr√≠a)"; cssClass = "tense-warning";
            } else if (or_kli > 2.0) {
                state = "Sobrepresi√≥n (Desborde)"; cssClass = "tense-danger";
            } else {
                state = "Tensi√≥n Operable"; cssClass = "tense-success";
            }
            return { state, or_kli: isNaN(or_kli) ? 0 : or_kli, cssClass };
        }

        function getMidaForKlipa(kli) {
            const num = reduceNumber(kli);
            return KLIPOT[num] || { mida: 'No Mapeada', klipa: 'No Mapeada' };
        }

        // =================================================================
        // 4. AN√ÅLISIS SDH Y S√çNTOMA
        // =================================================================

        function getSDHAnalysis(planet, symptom) {
            const sdh = CORRESPONDENCIA_PLANETA_SEFIRA[planet] || 'Desconocida';
            let s_afectadas = ["N/A"];
            let klipah = 'N/A';
            let tikun_focalizado = `An√°lisis pendiente para ${planet}.`;
            
            if (symptom === "Analisis General") {
                return { sdh, s_afectadas: ["Analisis General"], klipah: 'Klipot Estructural (TenSe)', tikun_focalizado: "" };
            }

            // L√≥gica expandida
            if (planet === "Saturno") {
                if (symptom === "Rigidez Mental") {
                    s_afectadas = ["Binah (Desborde)", "Jojm√° (Vaciado)"]; klipah = "Sathariel"; tikun_focalizado = "Integrar la fluidez de Jojm√°.";
                }
            } else if (planet === "Jupiter") {
                // Caso espec√≠fico para tu nuevo hallazgo
                if (symptom === "Rigidez Mental") {
                    s_afectadas = ["J√©sed (Desborde)", "Guevur√° (Mal Dirigida)"];
                    klipah = "Gha'agsheblah (El que golpea)";
                    tikun_focalizado = "Tu J√©sed (Expansi√≥n) est√° siendo sofocado. La rigidez no es tu estructura, es miedo a tu propia abundancia. Libera a J√∫piter.";
                }
            } else if (planet === "Marte") {
                if (symptom.includes("Tiran√≠a")) {
                    s_afectadas = ["Guevur√° (Desborde)", "J√©sed (Vaciado)"]; klipah = "Golachab"; tikun_focalizado = "Aplicar Agua (Misericordia) al Fuego.";
                }
            }
            
            if (klipah === 'N/A') {
                s_afectadas = [sdh.split('(')[0].trim() + " (SDH Focal)"];
                klipah = "Klipah Espec√≠fica";
                tikun_focalizado = `Revisa si est√°s operando desde el exceso o la carencia de ${planet}.`;
            }

            return { sdh, s_afectadas, klipah, tikun_focalizado };
        }

        // =================================================================
        // 5. RENDERIZADO
        // =================================================================

        function getTenSeAffectedSefirot(positions) {
            const affected = [];
            positions.forEach(pos => {
                const tense = calculateTense(pos.or, pos.kli);
                const ratio = tense.or_kli;
                let pressureType = '';
                if (ratio < 0.7) pressureType = 'Vaciado(TenSe)';
                else if (ratio > 2.0) pressureType = 'Desborde(TenSe)';
                else return;

                const sefirotInColumn = TENSE_STRUCTURAL_MAP[pos.title] || [];
                sefirotInColumn.forEach(sefira => affected.push(`${sefira} (${pressureType})`));
            });
            return affected;
        }

        function drawSefirotMap(affected_sefirot) {
            document.querySelectorAll('.sefira-node').forEach(node => node.classList.remove('color-desborde', 'color-vaciado'));
            affected_sefirot.forEach(afectada => {
                const parts = afectada.match(/(\w+) \((Desborde|Vaciado|Exceso|Defecto)/);
                if (parts) {
                    const nodeId = SEFIRA_TO_ID[parts[1]];
                    const state = parts[2];
                    if (nodeId) {
                        const node = document.getElementById(nodeId);
                        if (node) {
                            if (state.includes("Desborde") || state.includes("Exceso")) {
                                node.classList.remove('color-vaciado'); node.classList.add('color-desborde');
                            } else if ((state.includes("Vaciado") || state.includes("Defecto")) && !node.classList.contains('color-desborde')) {
                                node.classList.add('color-vaciado');
                            }
                        }
                    }
                }
            });
        }

        function generateSefirotMapHTML() {
            const svgPaths = `<svg viewBox="0 0 300 550" xmlns="http://www.w3.org/2000/svg"><line x1="150" y1="35" x2="50" y2="105" class="path"/><line x1="150" y1="35" x2="250" y2="105" class="path"/><line x1="150" y1="35" x2="150" y2="305" class="path"/><line x1="50" y1="105" x2="250" y2="105" class="path"/><line x1="50" y1="105" x2="50" y2="205" class="path"/><line x1="250" y1="105" x2="250" y2="205" class="path"/><line x1="50" y1="205" x2="250" y2="205" class="path"/><line x1="50" y1="205" x2="150" y2="305" class="path"/><line x1="250" y1="205" x2="150" y2="305" class="path"/><line x1="150" y1="305" x2="50" y2="375" class="path"/><line x1="150" y1="305" x2="250" y2="375" class="path"/><line x1="150" y1="305" x2="150" y2="435" class="path"/><line x1="50" y1="375" x2="250" y2="375" class="path"/><line x1="50" y1="375" x2="150" y2="435" class="path"/><line x1="250" y1="375" x2="150" y2="435" class="path"/><line x1="150" y1="435" x2="150" y2="510" class="path"/></svg>`;
            let nodesHTML = '';
            const labels = { 'Keter': 'Keter<br>(Voluntad)', 'Jojm√°': 'Jojm√°<br>(Sabidur√≠a)', 'Binah': 'Binah<br>(Estructura)', 'J√©sed': 'J√©sed<br>(Gracia)', 'Guevur√°': 'Guevur√°<br>(Rigor)', 'Tiferet': 'Tiferet<br>(Armon√≠a)', 'Netzaj': 'Netzaj<br>(Victoria)', 'Hod': 'Hod<br>(Raz√≥n)', 'Yesod': 'Yesod<br>(V√≠nculo)', 'Maljut': 'Maljut<br>(Reino)' };
            for (const [id, label] of Object.entries(labels)) nodesHTML += `<div id="${id}" class="sefira-node">${label}</div>`;
            
            return `<div class="sefirot-map-container"><div class="sefirot-map">${svgPaths}${nodesHTML}</div>
                <div class="sefirot-legend"><h4>Leyenda TenSe:</h4>
                <div class="legend-item"><div class="legend-box color-desborde"></div> Desborde (Rojo)</div>
                <div class="legend-item"><div class="legend-box color-vaciado"></div> Vaciado (Negro)</div>
                </div></div>`;
        }

        function calculateAIOK() {
            const d = parseInt(document.getElementById('day').value);
            const m = parseInt(document.getElementById('month').value);
            const a = parseInt(document.getElementById('year').value);
            const sdhFull = document.getElementById('sdhPlanet').value;
            const symptom = document.getElementById('symptom').value;

            if (!sdhFull || sdhFull.includes('Faltan')) { alert("Revisa la fecha y hora."); return; }
            const sdhPlanet = sdhFull.split('(')[0].trim();

            const rD = reduceNumber(d); const rM = reduceNumber(m); const rA = reduceNumber(a);
            const rTotal = reduceNumber(rD + rM + rA);
            const kli = calculateKliChallenges(rD, rM, rA);

            const positions = [
                { title: "Alma (D√≠a)", sefira: "Tiferet", or: rD, kli: kli.kliAlma, mida: getMidaForKlipa(kli.kliAlma) },
                { title: "Karma (Mes)", sefira: "Yesod", or: rM, kli: kli.kliKarma, mida: getMidaForKlipa(kli.kliKarma) },
                { title: "Destino (A√±o)", sefira: "Binah", or: rA, kli: kli.kliDestino, mida: getMidaForKlipa(kli.kliDestino) },
                { title: "Misi√≥n (Total)", sefira: "Maljut", or: rTotal, kli: kli.kliMision, mida: getMidaForKlipa(kli.kliMision) }
            ];

            let sdhAnalysis = getSDHAnalysis(sdhPlanet, symptom);
            const tense_s_afectadas = getTenSeAffectedSefirot(positions);
            let mapList = (symptom === "Analisis General") ? tense_s_afectadas : [...sdhAnalysis.s_afectadas, ...tense_s_afectadas];
            
            // --- CORRECCI√ìN: Generar Estrategia Autom√°tica para An√°lisis General ---
            if (symptom === "Analisis General") {
                // Buscamos la posici√≥n con el TenSe m√°s cr√≠tico (Vaciado o Desborde)
                let criticalPos = positions.find(p => {
                    const t = calculateTense(p.or, p.kli);
                    return t.state.includes("Vaciado") || t.state.includes("Desborde");
                });

                if (criticalPos) {
                    const t = calculateTense(criticalPos.or, criticalPos.kli);
                    const action = t.state.includes("Vaciado") ? "llenar el vac√≠o (Activaci√≥n)" : "drenar el exceso (Restricci√≥n)";
                    sdhAnalysis.tikun_focalizado = `<strong>Prioridad Estructural:</strong> Se detecta un fallo cr√≠tico en <strong>${criticalPos.title}</strong> (${t.state}).<br>Tu estrategia es usar la energ√≠a de <strong>${sdhPlanet}</strong> para <strong>${action}</strong> en esta √°rea, corrigiendo la Klipah de <em>${criticalPos.mida.klipa}</em>.`;
                } else {
                    sdhAnalysis.tikun_focalizado = "Tu estructura base es estable (TenSe Operable). Enf√≥cate en mantener el flujo de " + sdhPlanet + ".";
                }
            }
            // -----------------------------------------------------------------------

            let analysisHTML = `
                <div class="sdh-context">
                    <p><strong>Configuraci√≥n Energ√©tica:</strong><br>
                    Regente del D√≠a: <strong>${GLOBAL_SDH_CONTEXT.rulerOfDay}</strong> (Fondo)<br>
                    Regente de Hora (SDH): <strong>${GLOBAL_SDH_CONTEXT.planet}</strong> (Filtro Activo)</p>
                    <div class="sdh-detail-sub">Tu alma colorea la realidad a trav√©s de la lente de ${GLOBAL_SDH_CONTEXT.planet}.</div>
                </div>
                ${generateSefirotMapHTML()}
                <div class="result-grid">`;
            
            positions.forEach(pos => {
                const tense = calculateTense(pos.or, pos.kli);
                const border = TENSE_COLORS_MAP[tense.cssClass];
                analysisHTML += `<div class="result-card" style="border-left-color: ${border};">
                    <h3>${pos.title}</h3>
                    <p>Or/Kli: ${pos.or}/${pos.kli} = <strong>${tense.or_kli.toFixed(2)}</strong></p>
                    <p class="${tense.cssClass}">${tense.state}</p>
                    <p>Mida: ${pos.mida.mida}</p>
                </div>`;
            });
            analysisHTML += '</div>';
            document.getElementById('analysis-tab').innerHTML = analysisHTML;

            document.getElementById('sdh-tab').innerHTML = `
                <div class="sdh-analysis">
                    <h3>Diagn√≥stico: ${sdhPlanet} + ${symptom}</h3>
                    <p><strong>Sefirot Impactadas:</strong> ${mapList.join(', ')}</p>
                    <p><strong>Klipah Activa:</strong> ${sdhAnalysis.klipah}</p>
                    <hr>
                    <p><strong>Estrategia de Correcci√≥n:</strong> ${sdhAnalysis.tikun_focalizado}</p>
                </div>`;

            let tikkunHTML = '<h3>Plan de Acci√≥n TenSe</h3>';
            positions.forEach(pos => {
                const tense = calculateTense(pos.or, pos.kli);
                if (!tense.state.includes("Operable") && !tense.state.includes("Equilibrio")) {
                     const border = TENSE_COLORS_MAP[tense.cssClass];
                     const accion = tense.state.includes("Vaciado") ? "ACTIVACI√ìN (Rutina/Acci√≥n)" : "RESTRICCI√ìN (Silencio/Pausa)";
                     tikkunHTML += `<div class="tikun-practice" style="border-left: 3px solid ${border};">
                        <h4>${pos.title}: ${accion}</h4>
                        <p>Para corregir la klipah <em>${pos.mida.klipa}</em>, debes forzar la virtud de <strong>${pos.mida.mida}</strong> usando la energ√≠a de ${sdhPlanet}.</p>
                     </div>`;
                }
            });
            if(tikkunHTML === '<h3>Plan de Acci√≥n TenSe</h3>') tikkunHTML += '<p>Tus estructuras principales est√°n estables. Enf√≥cate en el Tikun del Rasgo Psicol√≥gico.</p>';
            
            document.getElementById('tikkun-tab').innerHTML = tikkunHTML + document.getElementById('sdh-tab').innerHTML;

            setTimeout(() => drawSefirotMap(mapList), 50);
            document.getElementById('results').style.display = 'block';
            showTab('analysis');
        }

        function showTab(t) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(t+'-tab').classList.add('active');
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tabs button[data-tab="${t}"]`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('calculateBtn').addEventListener('click', calculateAIOK);
            updateSDH();
        });
    </script>
</body>
</html>