<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klipapp v3.0 + v4.0 - Sistema Integrado</title>
    <style>
        :root {
            --primary: #2c5530;
            --secondary: #6f42c1;
            --danger: #dc3545;
            --warning: #fd7e14;
            --success: #20c997;
            --light: #f8f9fa;
            --dark: #333;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        input[type="date"] {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover { 
            background: #1e3a23; 
        }
        
        button.secondary {
            background: var(--secondary);
        }
        
        button.secondary:hover {
            background: #5a359a;
        }
        
        .results { 
            margin-top: 30px; 
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .emergency-card {
            border-left-color: var(--danger);
            background: #fff5f5;
        }
        
        .key-card {
            border-left-color: var(--success);
            background: #f0f9ff;
        }
        
        .tikkun-card {
            border-left-color: var(--secondary);
            background: #f8f9ff;
        }
        
        .overflow-card {
            border-left-color: var(--warning);
            background: #fff4e6;
        }
        
        .tense-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .tense-severe { background: var(--danger); color: white; }
        .tense-low { background: var(--warning); color: white; }
        .tense-critical { background: #ffc107; color: black; }
        .tense-high { background: var(--success); color: white; }
        
        .loading { 
            text-align: center; 
            padding: 20px; 
            display: none; 
        }
        
        .sefirot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .sefira-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            font-size: 0.9em;
        }
        
        .emergency-item {
            border-left-color: var(--danger);
            background: #fff5f5;
        }
        
        .overflow-item {
            border-left-color: var(--warning);
            background: #fff4e6;
        }
        
        .critical-item {
            border-left-color: #ffc107;
            background: #fffdf4;
        }
        
        .tense-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }
        
        .tense-item {
            padding: 8px;
            background: white;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8em;
        }
        
        .tense-value {
            font-size: 1.1em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .practice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .practice-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .practice-priority {
            display: inline-block;
            padding: 2px 8px;
            background: var(--secondary);
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        
        .practice-duration {
            color: #6c757d;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .klipa-section {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .klipa-overflow {
            background: #fff4e6;
            border-left: 4px solid var(--warning);
        }
        
        .klipa-vacuum {
            background: #fff5f5;
            border-left: 4px solid var(--danger);
        }
        
        .klipa-critical {
            background: #f0f9ff;
            border-left: 4px solid var(--success);
        }
        
        .week-plan {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .day-plan {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid var(--secondary);
        }
        
        .error-message {
            color: var(--danger);
            background: #fff5f5;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        
        .explanation-section {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
        }
        
        .explanation-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .summary-item {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            background: white;
        }
        
        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        @media (max-width: 600px) {
            .input-section, .nav-tabs { 
                flex-direction: column; 
            }
            
            input[type="date"] { 
                min-width: 100%; 
            }
            
            .sefirot-grid, .tense-map, .practice-grid, .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåø Klipapp v3.0 + v4.0</h1>
        <div class="subtitle">Mapa de Presiones + Sistema de Tikkun Integrado</div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="analysis">üìä An√°lisis Completo</div>
            <div class="nav-tab" data-tab="tikkun">üîÆ Plan de Tikkun</div>
        </div>

        <!-- PESTA√ëA AN√ÅLISIS COMPLETO -->
        <div class="tab-content active" id="analysis-tab">
            <div class="input-section">
                <input type="date" id="birthDate" value="1972-06-13">
                <button id="calculateBtn">Calcular Mapa de Presiones</button>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="loading" id="loading">
                <p>üîÑ Analizando tu cartograf√≠a energ√©tica completa...</p>
            </div>
            
            <div class="results" id="analysis-results">
                <div class="result-card">
                    <p>Ingresa tu fecha de nacimiento para ver tu mapa completo de presiones y Klipot.</p>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA PLAN DE TIKKUN -->
        <div class="tab-content" id="tikkun-tab">
            <div class="result-card">
                <h3>üîÆ Plan Personalizado de Tikkun</h3>
                <p>Completa el an√°lisis primero para generar tu plan de transformaci√≥n.</p>
            </div>
        </div>
    </div>

    <script>
        // ========== SISTEMA DE NAVEGACI√ìN ==========
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });

        // ========== MOTOR DE C√ÅLCULO v3.0 ==========
        function reduceNumber(num) {
            if (num === 11 || num === 22 || num === 33) return num;
            
            let result = num;
            while (result > 9) {
                let sum = 0;
                const str = result.toString();
                for (let i = 0; i < str.length; i++) {
                    sum += parseInt(str[i]);
                }
                result = sum;
                if (result === 11 || result === 22 || result === 33) break;
            }
            return result;
        }

        function calculateAllSefirot(d, m, a) {
            return {
                "Keter": Math.abs(d - a),
                "Jojma": Math.abs(d - m),
                "Bina": Math.abs(m - a),
                "Daat": Math.abs(Math.abs(d - m) - Math.abs(d - a)),
                "Jesed": Math.abs(d - Math.abs(m - a)),
                "Gevura": Math.abs(m - Math.abs(d - a)),
                "Tiferet": Math.abs(Math.abs(d - m) - Math.abs(m - a)),
                "Netsaj": Math.abs(Math.abs(d - a) - Math.abs(m - a)),
                "Hod": Math.abs(Math.abs(d - m) - Math.abs(d - a)),
                "Yesod": Math.abs(d - Math.abs(Math.abs(d - m) - Math.abs(m - a))),
                "Malkuth": Math.abs(a - Math.abs(d - m))
            };
        }

        function findEmergentSefirot(kliMap) {
            const entries = Object.entries(kliMap);
            entries.sort((a, b) => b[1] - a[1]);
            
            const shadowCentral = entries[0];
            const secondary = entries[1];
            const tertiary = entries[2];
            
            const keyValue = Math.abs(shadowCentral[1] - secondary[1]);
            let missionKey = entries[0];
            
            for (let i = 0; i < entries.length; i++) {
                if (Math.abs(entries[i][1] - keyValue) <= 1) {
                    missionKey = entries[i];
                    break;
                }
            }
            
            return {
                shadowCentral: { name: shadowCentral[0], value: shadowCentral[1] },
                secondary: { name: secondary[0], value: secondary[1] },
                tertiary: { name: tertiary[0], value: tertiary[1] },
                missionKey: { name: missionKey[0], value: missionKey[1] },
                allSefirot: entries
            };
        }

        function calculateTense(or, kli) {
            if (kli === 0) {
                return { value: Infinity, state: "Flujo Puro", badge: "tense-high", type: "overflow" };
            }
            const tenseValue = or / kli;
            if (tenseValue < 0.7) {
                return { value: tenseValue, state: "Subpresi√≥n Severa", badge: "tense-severe", type: "vacuum" };
            }
            if (tenseValue < 1) {
                return { value: tenseValue, state: "Subpresi√≥n", badge: "tense-low", type: "vacuum" };
            }
            if (tenseValue === 1) {
                return { value: tenseValue, state: "Punto Cr√≠tico", badge: "tense-critical", type: "critical" };
            }
            return { value: tenseValue, state: "Sobrepresi√≥n", badge: "tense-high", type: "overflow" };
        }

        function calculateAllTense(or, kliMap) {
            const tenseMap = {};
            for (const [sefira, kli] of Object.entries(kliMap)) {
                tenseMap[sefira] = calculateTense(or, kli);
            }
            return tenseMap;
        }

        function analyzeKlipot(tenseMap) {
            const klipot = {
                overflow: [],
                vacuum: [],
                critical: []
            };
            
            for (const [sefira, tense] of Object.entries(tenseMap)) {
                if (tense.type === "overflow") klipot.overflow.push({ sefira: sefira, tense: tense });
                if (tense.type === "vacuum") klipot.vacuum.push({ sefira: sefira, tense: tense });
                if (tense.type === "critical") klipot.critical.push({ sefira: sefira, tense: tense });
            }
            
            return klipot;
        }

        // ========== EXPLICACIONES PROFUNDAS COMPLETAS ==========
        function getDeepKlipaExplanation(sefira, type) {
            const explanations = {
                "Keter": {
                    "overflow": {
                        "title": "Klipa de Desborde en Keter - La Corona Inflada",
                        "explicacion": "Cuando Keter recibe m√°s Or del que puede contener, se genera una espiritualidad inflada y desconectada de la realidad terrenal.",
                        "manifestaciones": [
                            "B√∫squeda obsesiva de significado en todo",
                            "Desprecio por lo mundano y pr√°ctico",
                            "Espiritualidad de escape en lugar de integraci√≥n",
                            "Sentimiento de superioridad espiritual"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Keter - La Corona Quebrada",
                        "explicacion": "La vasija de Keter est√° demasiado vac√≠a para recibir el Or, generando una crisis existencial profunda.",
                        "manifestaciones": [
                            "Sentimiento de vac√≠o existencial",
                            "Falta de direcci√≥n y prop√≥sito vital",
                            "Desconexi√≥n de la gu√≠a interior",
                            "Crisis de fe y significado"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Keter - Umbral de Prop√≥sito",
                        "explicacion": "Keter en perfecto balance, momento de claridad existencial y conexi√≥n consciente con tu prop√≥sito.",
                        "manifestaciones": [
                            "Claridad sobre tu misi√≥n de vida",
                            "Conexi√≥n equilibrada con lo trascendente",
                            "Momento para decisiones existenciales importantes",
                            "Integraci√≥n arm√≥nica entre esp√≠ritu y materia"
                        ]
                    }
                },
                "Jojma": {
                    "overflow": {
                        "title": "Klipa de Desborde en Jojm√° - Sabidur√≠a Inundada",
                        "explicacion": "Exceso de Or en Jojm√° genera sobrecarga de ideas que no pueden materializarse.",
                        "manifestaciones": [
                            "Exceso de ideas sin aplicaci√≥n pr√°ctica",
                            "Inspiraci√≥n constante sin concretar",
                            "Dificultad para focalizar en un proyecto",
                            "Frustraci√≥n por no materializar visiones"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Jojm√° - Sabidur√≠a Obstruida",
                        "explicacion": "Vasija bloqueada impidiendo el flujo de inspiraci√≥n y comprensi√≥n profunda.",
                        "manifestaciones": [
                            "Bloqueo creativo persistente",
                            "Incapacidad para ver soluciones innovadoras",
                            "Mente r√≠gida y poco flexible",
                            "Falta de chispas inspiradoras"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Jojm√° - Sabidur√≠a Pura",
                        "explicacion": "Jojm√° en equilibrio perfecto, permitiendo recibir inspiraci√≥n con capacidad de aplicaci√≥n pr√°ctica.",
                        "manifestaciones": [
                            "Insights profundos y aplicables",
                            "Creatividad fluida y productiva",
                            "Capacidad para ver soluciones innovadoras",
                            "Inspiraci√≥n que se manifiesta naturalmente"
                        ]
                    }
                },
                "Bina": {
                    "overflow": {
                        "title": "Klipa de Desborde en Binah - Entendimiento Saturado",
                        "explicacion": "Exceso de Or en Binah genera an√°lisis excesivo y par√°lisis por sobrepensamiento.",
                        "manifestaciones": [
                            "An√°lisis interminable sin decisi√≥n",
                            "Par√°lisis por exceso de informaci√≥n",
                            "Dificultad para sintetizar y concluir",
                            "Sobrepensamiento que agota mentalmente"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Binah - Entendimiento Fragmentado",
                        "explicacion": "Vasija vac√≠a genera confusi√≥n mental y dificultad para comprender relaciones complejas.",
                        "manifestaciones": [
                            "Confusi√≥n y desorganizaci√≥n mental",
                            "Dificultad para entender conceptos abstractos",
                            "Pensamiento fragmentado y desconectado",
                            "Incapacidad para ver patrones y conexiones"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Binah - Entendimiento Profundo",
                        "explicacion": "Binah en perfecto balance, permitiendo an√°lisis profundos que conducen a decisiones sabias.",
                        "manifestaciones": [
                            "Capacidad de an√°lisis que lleva a acci√≥n",
                            "Comprensi√≥n profunda de situaciones complejas",
                            "Pensamiento estructurado y claro",
                            "Habilidad para discernir patrones ocultos"
                        ]
                    }
                },
                "Daat": {
                    "overflow": {
                        "title": "Klipa de Desborde en Daat - Conocimiento Forzado",
                        "explicacion": "Exceso de Or genera conexiones artificiales y s√≠ntesis prematuras.",
                        "manifestaciones": [
                            "Conexiones forzadas entre ideas dispares",
                            "Pseudos√≠ntesis sin fundamento real",
                            "Integraci√≥n superficial de conceptos",
                            "Conocimiento amplio pero poco profundo"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Daat - Conocimiento Desconectado",
                        "explicacion": "Vasija vac√≠a impide la integraci√≥n del conocimiento, generando fragmentaci√≥n.",
                        "manifestaciones": [
                            "Saberes desconectados y sin integraci√≥n",
                            "Dificultad para aplicar conocimiento te√≥rico",
                            "Fragmentaci√≥n entre entender y saber",
                            "Incapacidad para conectar ideas relacionadas"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Daat - Conocimiento Integrado",
                        "explicacion": "Daat en equilibrio perfecto, permitiendo la verdadera s√≠ntesis del conocimiento.",
                        "manifestaciones": [
                            "Integraci√≥n natural de saberes diversos",
                            "Capacidad para aplicar teor√≠a a la pr√°ctica",
                            "Visi√≥n hol√≠stica de situaciones complejas",
                            "S√≠ntesis creativa de ideas opuestas"
                        ]
                    }
                },
                "Jesed": {
                    "overflow": {
                        "title": "Klipa de Desborde en Jesed - Amor Devorador",
                        "explicacion": "Exceso de Or genera generosidad sin l√≠mites que termina siendo asfixiante.",
                        "manifestaciones": [
                            "Generosidad que agota tus recursos",
                            "Amor que sofoca en lugar de nutrir",
                            "Dificultad para poner l√≠mites amorosos",
                            "Sacrificio excesivo por otros"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Jesed - Amor Congelado",
                        "explicacion": "Vasija bloqueada impidiendo el flujo de amor y generosidad.",
                        "manifestaciones": [
                            "Aislamiento emocional y afectivo",
                            "Dificultad para dar y recibir amor",
                            "Frialdad emocional y distancia",
                            "Miedo a la intimidad y vulnerabilidad"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Jesed - Amor Incondicional",
                        "explicacion": "Jesed en perfecto balance, permitiendo dar y recibir amor de manera libre.",
                        "manifestaciones": [
                            "Amor que nutre sin sofocar",
                            "Generosidad equilibrada y sostenible",
                            "Capacidad para poner l√≠mites amorosos",
                            "Apertura emocional sin dependencia"
                        ]
                    }
                },
                "Gevura": {
                    "overflow": {
                        "title": "Klipa de Desborde en Gevur√° - Fuerza Tir√°nica",
                        "explicacion": "Exceso de Or genera fuerza desmedida que se convierte en rigidez y autoritarismo.",
                        "manifestaciones": [
                            "Rigidez extrema en principios y valores",
                            "Control excesivo sobre otros",
                            "Autoritarismo y falta de flexibilidad",
                            "Juicio severo hacia s√≠ mismo y otros"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Gevur√° - Fuerza Quebrada",
                        "explicacion": "Vasija vac√≠a genera falta de l√≠mites e incapacidad para defenderse.",
                        "manifestaciones": [
                            "Indefensi√≥n y falta de l√≠mites",
                            "Incapacidad para decir 'no'",
                            "Indecisi√≥n cr√≥nica y falta de firmeza",
                            "Permisividad que permite abusos"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Gevur√° - Fuerza Justa",
                        "explicacion": "Gevur√° en equilibrio perfecto, permitiendo establecer l√≠mites con compasi√≥n.",
                        "manifestaciones": [
                            "L√≠mites claros y respetuosos",
                            "Firmeza sin rigidez",
                            "Capacidad para decir no con amor",
                            "Disciplina que empodera"
                        ]
                    }
                },
                "Tiferet": {
                    "overflow": {
                        "title": "Klipa de Desborde en Tiferet - Belleza Artificial",
                        "explicacion": "Exceso de Or genera armon√≠a superficial que evita el conflicto necesario.",
                        "manifestaciones": [
                            "Armon√≠a superficial que evita conflictos",
                            "Belleza est√©tica sin sustancia real",
                            "Equilibrio forzado que reprime emociones",
                            "Imagen perfecta que oculta sombras"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Tiferet - Belleza Fragmentada",
                        "explicacion": "Vasija bloqueada genera desequilibrio emocional y falta de centro.",
                        "manifestaciones": [
                            "Desequilibrio emocional constante",
                            "Falta de centro y direcci√≥n clara",
                            "Crisis de identidad y valores",
                            "Incapacidad para integrar polaridades"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Tiferet - Belleza Aut√©ntica",
                        "explicacion": "Tiferet en perfecto balance, permitiendo la verdadera armon√≠a que integra todas las partes.",
                        "manifestaciones": [
                            "Armon√≠a interna aut√©ntica",
                            "Centro emocional estable",
                            "Identidad integrada y coherente",
                            "Capacidad para manejar conflictos constructivamente"
                        ]
                    }
                },
                "Netsaj": {
                    "overflow": {
                        "title": "Klipa de Desborde en Netsaj - Victoria Desbocada",
                        "explicacion": "Exceso de Or genera hiperactividad y dispersi√≥n energ√©tica.",
                        "manifestaciones": [
                            "Hiperactividad y multitasking excesivo",
                            "Inicio de m√∫ltiples proyectos sin terminar",
                            "Dispersi√≥n energ√©tica y falta de enfoque",
                            "Impaciencia por resultados inmediatos"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Netsaj - Victoria Estancada",
                        "explicacion": "Vasija vac√≠a genera desmotivaci√≥n y dificultad para concretar metas.",
                        "manifestaciones": [
                            "Desmotivaci√≥n y falta de impulso",
                            "Abandono de proyectos al primer obst√°culo",
                            "Falta de perseverancia y constancia",
                            "Dificultad para visualizar el √©xito"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Netsaj - Victoria Sostenible",
                        "explicacion": "Netsaj en equilibrio perfecto, permitiendo iniciativa efectiva y capacidad para concretar.",
                        "manifestaciones": [
                            "Iniciativa equilibrada con perseverancia",
                            "Capacidad para concretar proyectos",
                            "Energ√≠a sostenible sin agotamiento",
                            "Visi√≥n clara con acci√≥n consistente"
                        ]
                    }
                },
                "Hod": {
                    "overflow": {
                        "title": "Klipa de Desborde en Hod - Gloria Excesiva",
                        "explicacion": "Exceso de Or genera an√°lisis est√©ril y racionalizaci√≥n excesiva.",
                        "manifestaciones": [
                            "An√°lisis interminable sin acci√≥n",
                            "Racionalizaci√≥n que justifica inacci√≥n",
                            "Perfeccionismo paralizante",
                            "Sobre-estructuraci√≥n de procesos"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Hod - Gloria Desorganizada",
                        "explicacion": "Vasija vac√≠a genera caos mental y falta de estructura.",
                        "manifestaciones": [
                            "Caos mental y desorganizaci√≥n",
                            "Dificultad para seguir procesos",
                            "Falta de m√©todo y sistematicidad",
                            "Pensamiento desestructurado"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Hod - Gloria Estructurada",
                        "explicacion": "Hod en perfecto balance, permitiendo an√°lisis profundo que conduce a acci√≥n efectiva.",
                        "manifestaciones": [
                            "Pensamiento anal√≠tico que lleva a acci√≥n",
                            "Estructura que facilita la creatividad",
                            "Capacidad para organizar procesos complejos",
                            "An√°lisis que ilumina en lugar de paralizar"
                        ]
                    }
                },
                "Yesod": {
                    "overflow": {
                        "title": "Klipa de Desborde en Yesod - Fundaci√≥n L√≠quida",
                        "explicacion": "Exceso de Or genera identidad l√≠quida y adaptaci√≥n excesiva.",
                        "manifestaciones": [
                            "Identidad cambiante seg√∫n el contexto",
                            "Adaptaci√≥n excesiva a expectativas ajenas",
                            "Falta de n√∫cleo identitario estable",
                            "Dificultad para mantener coherencia personal"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Yesod - Fundaci√≥n Quebrada",
                        "explicacion": "Vasija vac√≠a genera falta de identidad y desarraigo.",
                        "manifestaciones": [
                            "Falta de sentido de identidad claro",
                            "Desarraigo y sensaci√≥n de no pertenencia",
                            "Dificultad para conectar con el propio cuerpo",
                            "Inestabilidad emocional b√°sica"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Yesod - Fundaci√≥n S√≥lida",
                        "explicacion": "Yesod en equilibrio perfecto, permitiendo una identidad estable y flexible.",
                        "manifestaciones": [
                            "Identidad clara y flexible",
                            "Buen contacto con el cuerpo y emociones",
                            "Autoexpresi√≥n aut√©ntica y coherente",
                            "Fundaci√≥n ps√≠quica s√≥lida"
                        ]
                    }
                },
                "Malkuth": {
                    "overflow": {
                        "title": "Klipa de Desborde en Malkuth - Reino Materialista",
                        "explicacion": "Exceso de Or genera acumulaci√≥n vac√≠a y materialismo.",
                        "manifestaciones": [
                            "Acumulaci√≥n material sin significado",
                            "Materialismo y apego a posesiones",
                            "Identificaci√≥n excesiva con logros terrenales",
                            "Dificultad para soltar y dejar fluir"
                        ]
                    },
                    "vacuum": {
                        "title": "Klipa de Vac√≠o en Malkuth - Reino Desconectado",
                        "explicacion": "Vasija vac√≠a genera desconexi√≥n terrenal y dificultad para manifestar.",
                        "manifestaciones": [
                            "Desconexi√≥n del cuerpo y lo f√≠sico",
                            "Dificultad para materializar ideas",
                            "Vivir en abstracciones sin anclaje real",
                            "Problemas pr√°cticos recurrentes"
                        ]
                    },
                    "critical": {
                        "title": "Punto Cr√≠tico en Malkuth - Reino Consciente",
                        "explicacion": "Malkuth en perfecto balance, permitiendo la manifestaci√≥n consciente con prop√≥sito.",
                        "manifestaciones": [
                            "Manifestaci√≥n alineada con prop√≥sito",
                            "Presencia plena en lo f√≠sico",
                            "Capacidad para disfrutar lo sensorial",
                            "Habilidad para materializar visiones"
                        ]
                    }
                }
            };
            
            return explanations[sefira]?.[type] || {
                "title": `Klipa ${type === "overflow" ? "de Desborde" : type === "vacuum" ? "de Vac√≠o" : "Cr√≠tica"} en ${sefira}`,
                "explicacion": "Esta Sefir√° se encuentra en un estado de desbalance energ√©tico que necesita atenci√≥n y transformaci√≥n consciente.",
                "manifestaciones": [
                    "Expresi√≥n desequilibrada de la energ√≠a de esta Sefir√°",
                    "Dificultad para integrar esta dimensi√≥n de manera arm√≥nica",
                    "Patrones repetitivos relacionados con este √°mbito",
                    "Resistencia al flujo natural en esta √°rea"
                ]
            };
        }

        // ========== SISTEMA DE TIKKUN v4.0 ==========
        function generateTikkunPractices(emergent, tenseMap, klipot, or) {
            const practices = [];
            
            practices.push({
                priority: "Alta",
                sefira: emergent.shadowCentral.name,
                title: "Tikkun de la Sombra Central - " + emergent.shadowCentral.name,
                description: "Pr√°ctica espec√≠fica para transformar el n√∫cleo del desaf√≠o principal en " + emergent.shadowCentral.name,
                duration: "15-20 min diarios",
                frequency: "Diaria",
                purpose: "Transformar el n√∫cleo del desaf√≠o principal"
            });
            
            practices.push({
                priority: "Alta", 
                sefira: emergent.missionKey.name,
                title: "Activaci√≥n de la Llave - " + emergent.missionKey.name,
                description: "Pr√°ctica para activar el recurso de soluci√≥n en " + emergent.missionKey.name,
                duration: "10-15 min diarios",
                frequency: "Diaria", 
                purpose: "Activar el recurso de soluci√≥n"
            });
            
            return practices;
        }

        function generateWeekPlan(practices) {
            return '<div class="week-plan"><h4>üìÖ Plan Semanal de Tikkun</h4><p>Plan personalizado basado en tus Klipot espec√≠ficas</p></div>';
        }

        // ========== FUNCI√ìN PRINCIPAL INTEGRADA ==========
        function calculateAIOK() {
            const birthDate = document.getElementById('birthDate').value;
            const loading = document.getElementById('loading');
            const results = document.getElementById('analysis-results');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            
            if (!birthDate) {
                showError('Por favor selecciona una fecha de nacimiento');
                return;
            }
            
            loading.style.display = 'block';
            results.style.display = 'none';
            
            setTimeout(function() {
                try {
                    const dateParts = birthDate.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    const day = parseInt(dateParts[2]);
                    
                    if (isNaN(year) || isNaN(month) || isNaN(day)) {
                        showError('Fecha de nacimiento inv√°lida');
                        return;
                    }
                    
                    const d_raw = day;
                    const m_raw = month;
                    const a_raw = year;
                    
                    const d = reduceNumber(d_raw);
                    const m = reduceNumber(m_raw);
                    const a = reduceNumber(a_raw);
                    const or = reduceNumber(d + m + a);
                    
                    // CALCULOS COMPLETOS
                    const kliMap = calculateAllSefirot(d, m, a);
                    const emergent = findEmergentSefirot(kliMap);
                    const tenseMap = calculateAllTense(or, kliMap);
                    const klipot = analyzeKlipot(tenseMap);
                    
                    const practices = generateTikkunPractices(emergent, tenseMap, klipot, or);
                    const weekPlan = generateWeekPlan(practices);
                    
                    const sefirotDefs = {
                        "Keter": "Corona - Prop√≥sito Supremo",
                        "Jojma": "Sabidur√≠a - Inspiraci√≥n Pura", 
                        "Bina": "Entendimiento - Mente Anal√≠tica",
                        "Daat": "Conocimiento - Integraci√≥n",
                        "Jesed": "Amor - Expansi√≥n",
                        "Gevura": "Fuerza - L√≠mites",
                        "Tiferet": "Belleza - Equilibrio",
                        "Netsaj": "Victoria - Perseverancia",
                        "Hod": "Gloria - Procesamiento",
                        "Yesod": "Fundaci√≥n - Identidad",
                        "Malkuth": "Reino - Manifestaci√≥n"
                    };
                    
                    const orMeanings = {
                        1: "liderazgo aut√©ntico y voluntad soberana",
                        2: "diplomacia y colaboraci√≥n", 
                        3: "expresi√≥n creativa y comunicaci√≥n",
                        4: "estabilidad y trabajo pr√°ctico",
                        5: "libertad y adaptabilidad",
                        6: "amor incondicional y belleza",
                        7: "sabidur√≠a e introspecci√≥n",
                        8: "poder y abundancia",
                        9: "compasi√≥n universal"
                    };
                    
                    let resultHTML = '';
                    
                    // 1. DATOS BASE
                    resultHTML += '<div class="result-card">';
                    resultHTML += '<h3>üìä Datos de Nacimiento</h3>';
                    resultHTML += '<p>Fecha: ' + birthDate + '</p>';
                    resultHTML += '<p>D√≠a: ' + d_raw + ' | Mes: ' + m_raw + ' | A√±o: ' + a_raw + '</p>';
                    resultHTML += '</div>';
                    
                    // 2. POTENCIAL DE MISI√ìN
                    resultHTML += '<div class="result-card">';
                    resultHTML += '<h3>üí´ Potencial de Misi√≥n (Or)</h3>';
                    resultHTML += '<p><strong>N√∫mero ' + or + '</strong> - ' + (orMeanings[or] || "potencial √∫nico") + '</p>';
                    resultHTML += '</div>';
                    
                    // 3. SEFIROT EMERGENTES
                    resultHTML += '<div class="result-card emergency-card">';
                    resultHTML += '<h3>üéØ Triada de Sefirot Emergentes</h3>';
                    resultHTML += '<div class="sefirot-grid">';
                    resultHTML += '<div class="sefira-item emergency-item">';
                    resultHTML += '<strong>' + emergent.shadowCentral.name + '</strong><br>';
                    resultHTML += 'Kli: ' + emergent.shadowCentral.value + '<br>';
                    resultHTML += '<small>' + sefirotDefs[emergent.shadowCentral.name] + '</small>';
                    resultHTML += '</div>';
                    resultHTML += '<div class="sefira-item">';
                    resultHTML += '<strong>' + emergent.secondary.name + '</strong><br>';
                    resultHTML += 'Kli: ' + emergent.secondary.value + '<br>';
                    resultHTML += '<small>' + sefirotDefs[emergent.secondary.name] + '</small>';
                    resultHTML += '</div>';
                    resultHTML += '<div class="sefira-item">';
                    resultHTML += '<strong>' + emergent.tertiary.name + '</strong><br>';
                    resultHTML += 'Kli: ' + emergent.tertiary.value + '<br>';
                    resultHTML += '<small>' + sefirotDefs[emergent.tertiary.name] + '</small>';
                    resultHTML += '</div>';
                    resultHTML += '</div>';
                    resultHTML += '</div>';
                    
                    // 4. LLAVE DE LA MISI√ìN
                    resultHTML += '<div class="result-card key-card">';
                    resultHTML += '<h3>üîë Llave de la Misi√≥n</h3>';
                    resultHTML += '<p><strong>' + emergent.missionKey.name + '</strong> (Kli ' + emergent.missionKey.value + ')</p>';
                    resultHTML += '<p>' + sefirotDefs[emergent.missionKey.name] + '</p>';
                    resultHTML += '<p><em>Esta Sefira contiene la soluci√≥n para transformar tu Sombra Central</em></p>';
                    resultHTML += '</div>';
                    
                    // 5. RESUMEN DEL ESTADO ENERG√âTICO
                    resultHTML += '<div class="result-card key-card">';
                    resultHTML += '<h3>üìà Resumen del Estado Energ√©tico</h3>';
                    
                    const overflowCount = klipot.overflow.length;
                    const vacuumCount = klipot.vacuum.length;
                    const criticalCount = klipot.critical.length;
                    
                    resultHTML += '<div class="summary-grid">';
                    resultHTML += '<div class="summary-item" style="background: #fff5f5;">';
                    resultHTML += '<strong>Vasijas Vac√≠as</strong><br>';
                    resultHTML += '<div class="summary-value" style="color: var(--danger);">' + vacuumCount + '</div>';
                    resultHTML += '<small>√Åreas bloqueadas</small>';
                    resultHTML += '</div>';
                    
                    resultHTML += '<div class="summary-item" style="background: #fff4e6;">';
                    resultHTML += '<strong>Desbordes</strong><br>';
                    resultHTML += '<div class="summary-value" style="color: var(--warning);">' + overflowCount + '</div>';
                    resultHTML += '<small>Excesos por canalizar</small>';
                    resultHTML += '</div>';
                    
                    resultHTML += '<div class="summary-item" style="background: #f0f9ff;">';
                    resultHTML += '<strong>Puntos Cr√≠ticos</strong><br>';
                    resultHTML += '<div class="summary-value" style="color: var(--success);">' + criticalCount + '</div>';
                    resultHTML += '<small>√Åreas en transformaci√≥n</small>';
                    resultHTML += '</div>';
                    resultHTML += '</div>';
                    
                    let diagnostico = "";
                    if (vacuumCount >= 3) {
                        diagnostico = "Perfil predominantemente bloqueado - Necesita activaci√≥n energ√©tica";
                    } else if (overflowCount >= 3) {
                        diagnostico = "Perfil predominantemente expansivo - Necesita canalizaci√≥n y enfoque";
                    } else if (criticalCount >= 2) {
                        diagnostico = "Perfil en transformaci√≥n activa - Momentos de integraci√≥n clave";
                    } else {
                        diagnostico = "Perfil balanceado - Enfocarse en la Sombra Central y Llave de Misi√≥n";
                    }
                    
                    resultHTML += '<p><strong>Diagn√≥stico:</strong> ' + diagnostico + '</p>';
                    resultHTML += '</div>';
                    
                    // 6. MAPA DE PRESIONES
                    resultHTML += '<div class="result-card">';
                    resultHTML += '<h3>üó∫Ô∏è Mapa Completo de Presiones (TenSe)</h3>';
                    resultHTML += '<div class="tense-map">';
                    
                    for (const [sefira, tense] of Object.entries(tenseMap)) {
                        const isEmergent = [emergent.shadowCentral.name, emergent.secondary.name, emergent.tertiary.name].includes(sefira);
                        const itemClass = isEmergent ? 'emergency-item' : 
                                         tense.type === 'overflow' ? 'overflow-item' : 
                                         tense.type === 'critical' ? 'critical-item' : '';
                        
                        resultHTML += '<div class="tense-item ' + itemClass + '">';
                        resultHTML += '<strong>' + sefira + '</strong><br>';
                        resultHTML += '<div class="tense-value">' + (tense.value === Infinity ? "‚àû" : tense.value.toFixed(2)) + '</div>';
                        resultHTML += '<small>' + tense.state + '</small>';
                        resultHTML += '</div>';
                    }
                    
                    resultHTML += '</div>';
                    resultHTML += '</div>';
                    
                    // 7. KLIPOT DE DESBORDE - TODAS
                    if (klipot.overflow.length > 0) {
                        resultHTML += '<div class="result-card overflow-card">';
                        resultHTML += '<h3>üî• Klipot de Desborde (TenSe > 1) - ' + klipot.overflow.length + ' detectadas</h3>';
                        resultHTML += '<p><em>√Åreas con exceso de energ√≠a que necesitan canalizaci√≥n</em></p>';
                        
                        klipot.overflow.sort((a, b) => b.tense.value - a.tense.value);
                        
                        klipot.overflow.forEach((klipa, index) => {
                            const deepExplanation = getDeepKlipaExplanation(klipa.sefira, "overflow");
                            
                            resultHTML += '<div class="klipa-section klipa-overflow">';
                            resultHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                            resultHTML += '<strong>' + klipa.sefira + '</strong>';
                            resultHTML += '<span class="tense-badge ' + klipa.tense.badge + '">';
                            resultHTML += 'TenSe: ' + (klipa.tense.value === Infinity ? "‚àû" : klipa.tense.value.toFixed(2));
                            resultHTML += '</span>';
                            resultHTML += '</div>';
                            
                            resultHTML += '<div class="explanation-section">';
                            resultHTML += '<div class="explanation-title">' + (index + 1) + '. ' + deepExplanation.title + '</div>';
                            resultHTML += '<p>' + deepExplanation.explicacion + '</p>';
                            resultHTML += '<p><strong>Manifestaciones comunes:</strong></p>';
                            resultHTML += '<ul>';
                            deepExplanation.manifestaciones.forEach(m => {
                                resultHTML += '<li>' + m + '</li>';
                            });
                            resultHTML += '</ul>';
                            resultHTML += '</div>';
                            resultHTML += '</div>';
                        });
                        resultHTML += '</div>';
                    }
                    
                    // 8. KLIPOT DE VASIJA VAC√çA - TODAS
                    if (klipot.vacuum.length > 0) {
                        resultHTML += '<div class="result-card emergency-card">';
                        resultHTML += '<h3>üí¢ Klipot de Vasija Vac√≠a (TenSe < 1) - ' + klipot.vacuum.length + ' detectadas</h3>';
                        resultHTML += '<p><em>√Åreas con bloqueo energ√©tico que necesitan activaci√≥n</em></p>';
                        
                        klipot.vacuum.sort((a, b) => a.tense.value - b.tense.value);
                        
                        klipot.vacuum.forEach((klipa, index) => {
                            const deepExplanation = getDeepKlipaExplanation(klipa.sefira, "vacuum");
                            
                            resultHTML += '<div class="klipa-section klipa-vacuum">';
                            resultHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                            resultHTML += '<strong>' + klipa.sefira + '</strong>';
                            resultHTML += '<span class="tense-badge ' + klipa.tense.badge + '">';
                            resultHTML += 'TenSe: ' + klipa.tense.value.toFixed(2);
                            resultHTML += '</span>';
                            resultHTML += '</div>';
                            
                            resultHTML += '<div class="explanation-section">';
                            resultHTML += '<div class="explanation-title">' + (index + 1) + '. ' + deepExplanation.title + '</div>';
                            resultHTML += '<p>' + deepExplanation.explicacion + '</p>';
                            resultHTML += '<p><strong>Manifestaciones comunes:</strong></p>';
                            resultHTML += '<ul>';
                            deepExplanation.manifestaciones.forEach(m => {
                                resultHTML += '<li>' + m + '</li>';
                            });
                            resultHTML += '</ul>';
                            resultHTML += '</div>';
                            resultHTML += '</div>';
                        });
                        resultHTML += '</div>';
                    }
                    
                    // 9. PUNTOS CR√çTICOS - TODOS
                    if (klipot.critical.length > 0) {
                        resultHTML += '<div class="result-card key-card">';
                        resultHTML += '<h3>‚ö° Puntos Cr√≠ticos (TenSe = 1) - ' + klipot.critical.length + ' detectados</h3>';
                        resultHTML += '<p><em>√Åreas en perfecto balance energ√©tico - momentos de m√°xima potencialidad transformadora</em></p>';
                        
                        klipot.critical.forEach((klipa, index) => {
                            const deepExplanation = getDeepKlipaExplanation(klipa.sefira, "critical");
                            
                            resultHTML += '<div class="klipa-section klipa-critical">';
                            resultHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                            resultHTML += '<strong>' + klipa.sefira + '</strong>';
                            resultHTML += '<span class="tense-badge ' + klipa.tense.badge + '">';
                            resultHTML += 'TenSe: ' + klipa.tense.value.toFixed(2);
                            resultHTML += '</span>';
                            resultHTML += '</div>';
                            
                            resultHTML += '<div class="explanation-section">';
                            resultHTML += '<div class="explanation-title">' + (index + 1) + '. ' + deepExplanation.title + '</div>';
                            resultHTML += '<p>' + deepExplanation.explicacion + '</p>';
                            resultHTML += '<p><strong>Oportunidades de transformaci√≥n:</strong></p>';
                            resultHTML += '<ul>';
                            deepExplanation.manifestaciones.forEach(m => {
                                resultHTML += '<li>' + m + '</li>';
                            });
                            resultHTML += '</ul>';
                            resultHTML += '</div>';
                            resultHTML += '</div>';
                        });
                        resultHTML += '</div>';
                    }
                    
                    // 10. BOT√ìN PARA TIKKUN
                    resultHTML += '<div class="result-card tikkun-card">';
                    resultHTML += '<h3>üîÆ ¬øListo para Transformar?</h3>';
                    resultHTML += '<p>Tu an√°lisis est√° completo. Ahora puedes ver tu plan personalizado de Tikkun.</p>';
                    resultHTML += '<button class="secondary" onclick="showTikkunPlan()">Ver Mi Plan de Tikkun</button>';
                    resultHTML += '</div>';
                    
                    results.innerHTML = resultHTML;
                    loading.style.display = 'none';
                    results.style.display = 'block';
                    
                    window.currentAnalysis = { practices, weekPlan, or, emergent };
                    
                } catch (error) {
                    loading.style.display = 'none';
                    showError('Error en el c√°lculo: ' + error.message);
                }
            }, 1500);
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showTikkunPlan() {
            if (!window.currentAnalysis) {
                showError('Completa el an√°lisis primero');
                return;
            }
            
            const { practices, weekPlan, or, emergent } = window.currentAnalysis;
            
            const tikkunHTML = `
                <div class="result-card tikkun-card">
                    <h3>üîÆ Plan de Tikkun Personalizado</h3>
                    <p>Basado en tu an√°lisis: Or ${or} - Sombra: ${emergent.shadowCentral.name}</p>
                </div>
                
                <div class="result-card">
                    <h3>üéØ Pr√°cticas de Reparaci√≥n</h3>
                    <div class="practice-grid">
                        ${practices.map(practice => `
                            <div class="practice-item">
                                <div class="practice-priority">${practice.priority} Prioridad</div>
                                <h4>${practice.title}</h4>
                                <div class="practice-duration">${practice.duration} | ${practice.frequency}</div>
                                <p>${practice.description}</p>
                                <small><strong>Prop√≥sito:</strong> ${practice.purpose}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>üìÖ Organizaci√≥n Semanal</h3>
                    ${weekPlan}
                </div>
                
                <div class="result-card">
                    <h3>üîÑ Volver al An√°lisis</h3>
                    <button onclick="showAnalysis()">üìä Ver An√°lisis Completo</button>
                </div>
            `;
            
            document.getElementById('tikkun-tab').innerHTML = tikkunHTML;
            document.querySelector('[data-tab="tikkun"]').click();
        }

        function showAnalysis() {
            document.querySelector('[data-tab="analysis"]').click();
        }

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('calculateBtn').addEventListener('click', calculateAIOK);
        });
    </script>
</body>
</html>